<%- include('../partials/header', { title: 'Dashboard' }) %>

<button id="toggleSidebar" class="hamburger" style="margin-bottom: 20px">
  â˜°
</button>

<div class="dashboard-container">
  <aside class="sidebar">
    <div class="logo-title">
        <% if (info?.logo_url) { %>
        <a href="/"><img src="<%= info.logo_url %>" alt="Logo" /></a>
        <% } %>
        <p><%= info?.company_name || 'C&S Church Online' %></p>
      </div>
    <div class="sidebar-header">
      <% if (profilePic) { %>
      <img src="<%= profilePic %>" alt="Profile Picture" class="profile-pic" />
      <% } else { %>
      <img
        src="/images/profile male.png"
        alt="Default Profile Picture"
        class="profile-pic"
      />
      <% } %>
    </div>
    <h2>ğŸ‘¤ <%= student.fullname %></h2>

    <!-- <ul>
      <li>
        <button class="nav-tab" data-section="dashboard">ğŸ  Dashboard</button>
      </li>
      <li>
        <button class="nav-tab" data-section="courses">ğŸ“š My Courses</button>
      </li>
      <li>
        <button class="nav-tab" data-section="progress">ğŸ“ˆ Progress</button>
      </li>
      <li><button class="nav-tab" data-section="badges">ğŸ–ï¸ Badges</button></li>
      <li><a href="/admin/logout">ğŸšª Logout</a></li>
    </ul> -->
    <ul class="sidebar-nav">
      <li><a href="/student/dashboard">ğŸ  Dashboard</a></li>

      <!-- Profile -->
      <!-- <li><a href="/student/profile">ğŸ‘¤ My Profile</a></li> -->
       <li><a href="/student/dashboard?section=profile">ğŸ‘¤ My Profile</a></li>
       <p style="color: black;">ğŸ’° Wallet: â‚¦<%= walletBalance.toLocaleString() %></p>

      <!-- Pathways / Courses -->
      <li>
        <button class="dropdown-btn">ğŸ“‚ My Pathways â–¾</button>
        
        <ul class="dropdown-container">
          <% Object.keys(pathwayCourses).forEach(pathway => { %>
          <li>
            <a
              href="/student/dashboard?pathway=<%= encodeURIComponent(pathway) %>"
            >
              <%= pathway %>
            </a>
          </li>
          <% }) %>
        </ul>
      </li>

      <li><a href="/admin/logout">ğŸšª Logout</a></li>
    </ul>
  </aside>

  <!-- <main class="main-content">
    <h1>Welcome, <%= student.fullname %>!</h1>

    <section class="progress-summary">
      <h3>Course Progress Overview</h3>
      <% enrolledCourses.forEach(course => { %>
      <div class="course-card">
        <h4><%= course.title %></h4>
        <div class="progress-bar">
          <div class="filled" style="width: <%= course.progress %>%"></div>
        </div>
        <p><%= course.progress %>% complete</p>
      </div>
      <% }) %>
    </section>

    <section class="gamification">
      <h3>ğŸ… My Gamification</h3>
      <p>XP Points: <strong><%= student.xp %></strong></p>
      <p>Level: <strong><%= student.level %></strong></p>
      <div class="badges">
        <% badges.forEach(badge => { %>
        <span class="badge"><%= badge.title %></span>
        <% }) %>
      </div>
    </section>

    <section class="charts">
      <h3>Analytics</h3>
      <canvas id="progressChart"></canvas>
    </section>
  </main> -->

 <main class="main-content">
  <% if (section === 'profile') { %>
    <!-- ğŸ‘¤ PROFILE SECTION -->
    <div class="profile-container">
      <h2>ğŸ‘¤ My Profile</h2>

      <div class="profile-card">
        <img src="<%= profilePic || '/images/profile male.png' %>" class="profile-pic-large" />
        <p><strong>Full Name:</strong> <%= student.fullname %></p>
        <p><strong>Gender:</strong> <%= student.gender %></p>
        <p><strong>Date of Birth:</strong> <%= student.dob ? student.dob.toISOString().split('T')[0] : 'N/A' %></p>
        <p style="color: black;">ğŸ’° Wallet: â‚¦<%= walletBalance.toLocaleString() %></p>
        <button class="btn-create" onclick="openEditModal('profile')">âœï¸ Edit Profile</button>
      </div>

      <!-- EDIT MODAL -->
      <div id="editModal-profile" class="modal">
        <div class="modal-content">
          <span class="close" onclick="closeEditModal('profile')">&times;</span>
          <h3>Edit My Profile</h3>
          <form action="/student/profile/edit" method="POST" enctype="multipart/form-data">
            <input type="hidden" name="existingPic" value="<%= profilePic %>" />
            
            <label>Full Name</label>
            <input type="text" name="fullname" value="<%= student.fullname %>" required />

            <label>Gender</label>
            <select name="gender" required>
              <option value="Male" <%= student.gender === 'Male' ? 'selected' : '' %>>Male</option>
              <option value="Female" <%= student.gender === 'Female' ? 'selected' : '' %>>Female</option>
            </select>

            <label>Date of Birth</label>
            <input type="date" name="dob" value="<%= student.dob ? student.dob.toISOString().split('T')[0] : '' %>" required />

            <label>Profile Picture</label>
            <input type="file" name="profilePic" />

            <button type="submit">Save Changes</button>
          </form>
        </div>
      </div>
    </div>

  <% }
   else if (!selectedPathway || !pathwayCourses[selectedPathway]) { %>
    <!-- DASHBOARD VIEW -->
    <section class="stats-boxes">
      <div class="stat-box light-blue">
        <h4>ğŸ“˜ Courses Completed</h4>
        <p><%= completedCourses %></p>
      </div>
      <div class="stat-box light-pink">
        <h4>ğŸ—‚ï¸ Completed Projects</h4>
        <p><%= completedProjects %></p>
      </div>
      <div class="stat-box light-yellow">
        <h4>ğŸ… Badges Earned</h4>
        <p><%= badges.length %></p>
      </div>
      <div class="stat-box light-grey">
        <h4>ğŸ“œ Certificates</h4>
        <p><%= certificatesCount %></p>
      </div>
    </section>

    <div class="analytics-wrapper">
      <div class="analytics-filters">
        <select>
          <option selected>This Week</option>
        </select>
      </div>
      <canvas id="engagementChart"></canvas>
    </div>

    <div class="chart-section">
      <h3>ğŸ“Š Course Completion Progress</h3>
      <canvas id="courseProgressChart"></canvas>
    </div>

    <h2>Continue Learning</h2>
    <div class="course-grid">
      <% enrolledCourses.forEach(course => { %>
      <div class="course-card3">
        <img src="<%= course.thumbnail_url %>" alt="" />
        <div>
          <h4><%= course.title %></h4>
          <p><%= course.progress %>% complete</p>
          <div class="progress-bar">
            <div class="filled" style="width: <%= course.progress %>%"></div>
          </div>
        </div>
      </div>
      <% }) %>
    </div>

  <% } else { %>
    <!-- PATHWAY VIEW -->
    <section class="pathway-section">
      <h2><%= selectedPathway %> Courses</h2>

      <% pathwayCourses[selectedPathway].forEach(course => { %>
      <div class="course-section">
        <h3><%= course.title %></h3>
        <div class="modules-scroll">
          <% (courseModules[course.id] || []).forEach(mod => { %>
          <div class="module-card">
            <img
              style="width: 100%; height: 100px; object-fit: contain"
              src="<%= mod.thumbnail || '/images/JKT logo bg.png' %>"
              alt=""
            />
            <h4><%= mod.title %></h4>
            <a href="/student/courses/<%= course.id %>/modules/<%= mod.id %>">View Module</a>
          </div>
          <% }) %>
        </div>
      </div>
      <% }) %>
    </section>
  <% } %>
</main>

</div>

<!-- <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> -->

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Script for engagement char -->
<script>
  const ctx = document.getElementById('engagementChart').getContext('2d');
  const chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: <%- JSON.stringify(engagementData.labels) %>,
      datasets: [{
        label: 'Lessons Completed',
        data: <%- JSON.stringify(engagementData.data) %>,
        borderColor: '#2196f3',
        fill: false,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
</script>

<!-- Script for course progress chart -->
<script>
  const ctx2 = document.getElementById('courseProgressChart').getContext('2d');
  const courseProgressChart = new Chart(ctx2, {
    type: 'bar',
    data: {
      labels: <%- JSON.stringify(enrolledCourses.map(c => c.title)) %>,
      datasets: [{
        label: 'Progress (%)',
        data: <%- JSON.stringify(enrolledCourses.map(c => c.progress)) %>,
        backgroundColor: [
          '#4CAF50',
          '#2196F3',
          '#FFC107',
          '#FF5722',
          '#9C27B0',
          '#3F51B5',
          '#E91E63',
          '#00BCD4',
          '#8BC34A',
          '#FF9800'
        ],
        borderRadius: 4
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          title: {
            display: true,
            text: 'Completion (%)'
          }
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function(context) {
              return `${context.parsed.y}% completed`;
            }
          }
        }
      }
    }
  });
</script>

<!-- Script for sidebar -->
<script>
  document.querySelectorAll(".dropdown-btn").forEach((btn) => {
    btn.addEventListener("click", function () {
      this.classList.toggle("active");
      const dropdown = this.nextElementSibling;
      dropdown.style.display =
        dropdown.style.display === "block" ? "none" : "block";
    });
  });

  document.querySelectorAll(".sub-dropdown-btn").forEach((btn) => {
    btn.addEventListener("click", function () {
      this.classList.toggle("active");
      const sub = this.nextElementSibling;
      sub.style.display = sub.style.display === "block" ? "none" : "block";
    });
  });
</script>

<!-- script to Highlight active navbar -->
<script>
  const tabs = document.querySelectorAll(".nav-tab");
  tabs.forEach((tab) => {
    if (tab.href === window.location.href) {
      tab.classList.add("active");
    }
  });
  document
    .getElementById("toggleSidebar")
    .addEventListener("click", function () {
      document.querySelector(".sidebar").classList.toggle("open");
    });
</script>

<!-- script for edit modal -->
 <script>
  function openEditModal(id) {
    document.getElementById("editModal-" + id).style.display = "block";
  }

  function closeEditModal(id) {
    document.getElementById("editModal-" + id).style.display = "none";
  }
</script>